<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Viewer with Highlights, Notes, and Stamps</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
        #pdf-canvas { border: 1px solid #ccc; width: 100%; }
        #toolbar { padding: 10px; background-color: #f1f1f1; }
        #annotations { max-height: 300px; overflow-y: auto; border-top: 1px solid #ccc; }
        #export-btn { margin: 10px 0; }
        .note { position: absolute; background-color: yellow; padding: 2px 4px; border: 1px solid #000; cursor: move; }
        .highlight { background-color: yellow; }
        .stamp { position: absolute; }
        #thumbnail-container { width: 120px; overflow-y: auto; float: left; height: 100vh; border-right: 1px solid #ccc; }
        #thumbnail-container canvas { margin-bottom: 5px; cursor: pointer; }
        #main-content { margin-left: 120px; }
    </style>
</head>
<body>

<div id="toolbar">
    <input type="file" id="file-input" accept="application/pdf" />
    <button onclick="downloadAnnotations()">Download Highlights & Notes</button>
    <button onclick="toggleHighlight()">Toggle Highlighter</button>
    <button onclick="toggleStamp()">Toggle Stamp</button>
    <select id="stamp-shape">
        <option value="circle">Circle</option>
        <option value="triangle">Triangle</option>
        <option value="square">Square</option>
    </select>
    <select id="color-picker">
        <option value="yellow">Yellow</option>
        <option value="blue">Blue</option>
        <option value="green">Green</option>
        <option value="red">Red</option>
        <option value="purple">Purple</option>
    </select>
</div>

<div id="thumbnail-container"></div>
<div id="main-content">
    <canvas id="pdf-canvas"></canvas>
</div>
<div id="annotations"></div>

<script>
let pdfDoc = null;
let annotations = JSON.parse(localStorage.getItem('annotations')) || [];
let currentPage = 1;
let pdfName = '';
let isStampMode = false;
let isHighlightMode = false;

function renderPage(num) {
    pdfDoc.getPage(num).then(page => {
        const canvas = document.getElementById('pdf-canvas');
        const ctx = canvas.getContext('2d');
        const viewport = page.getViewport({ scale: 1.5 });
        canvas.height = viewport.height;
        canvas.width = viewport.width;

        page.render({ canvasContext: ctx, viewport: viewport });

        canvas.onclick = (e) => {
            if (isStampMode) {
                addStamp(e, num);
            } else if (isHighlightMode) {
                addHighlight(e, num);
            }
        };
    });
}

function toggleHighlight() {
    isHighlightMode = !isHighlightMode;
    isStampMode = false;
}

function toggleStamp() {
    isStampMode = !isStampMode;
    isHighlightMode = false;
}

function addHighlight(e, pageNum) {
    const color = document.getElementById('color-picker').value;
    const highlight = document.createElement('div');
    highlight.className = 'highlight';
    highlight.style.backgroundColor = color;
    highlight.style.left = `${e.offsetX}px`;
    highlight.style.top = `${e.offsetY}px`;
    highlight.textContent = '🖍';

    document.querySelector('#main-content').appendChild(highlight);
}

function addStamp(e, pageNum) {
    const shape = document.getElementById('stamp-shape').value;
    const color = document.getElementById('color-picker').value;
    const stamp = document.createElement('div');
    stamp.className = 'stamp';
    stamp.style.backgroundColor = color;
    stamp.style.left = `${e.offsetX}px`;
    stamp.style.top = `${e.offsetY}px`;
    stamp.style.width = '20px';
    stamp.style.height = '20px';

    if (shape === 'circle') {
        stamp.style.borderRadius = '50%';
    } else if (shape === 'triangle') {
        stamp.style.width = '0';
        stamp.style.height = '0';
        stamp.style.borderLeft = '10px solid transparent';
        stamp.style.borderRight = '10px solid transparent';
        stamp.style.borderBottom = `20px solid ${color}`;
    } else if (shape === 'square') {
        stamp.style.borderRadius = '0';
    }

    document.querySelector('#main-content').appendChild(stamp);
}

document.getElementById('file-input').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        pdfName = file.name.split('.pdf')[0];
        const fileReader = new FileReader();
        fileReader.onload = (event) => {
            const typedarray = new Uint8Array(event.target.result);
            pdfjsLib.getDocument(typedarray).promise.then(pdf => {
                pdfDoc = pdf;
                currentPage = 1;
                renderPage(1);
            });
        };
        fileReader.readAsArrayBuffer(file);
    }
});
</script>

</body>
</html>
