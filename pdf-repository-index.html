<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Repository</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
        }
        canvas {
            border: 1px solid #ccc;
            margin-bottom: 20px;
        }
        textarea {
            width: 100%;
            height: 100px;
        }
    </style>
</head>
<body>
    <h1>PDF Repository</h1>
    <p>Click on any PDF to view it.</p>
    <div id="pdf-list"></div>

    <div id="pdf-viewer" style="display:none;">
        <input type="text" id="search-input" placeholder="Search text">
        <button onclick="searchText()">Find</button>
        <span id="page-info"></span>
        <button onclick="prevPage()">Previous</button>
        <button onclick="nextPage()">Next</button>
        <button onclick="downloadHighlights()">Download Highlights</button>
        <br><br>
        <canvas id="pdf-canvas"></canvas>
        <textarea id="note-input" placeholder="Insert a note"></textarea>
        <button onclick="addNote()">Add Note</button>
    </div>

    <script>
        let pdfDoc = null;
        let pageNum = 1;
        let pageRendering = false;
        let pageNumPending = null;
        let canvas = document.getElementById('pdf-canvas');
        let ctx = canvas.getContext('2d');
        let highlights = [];
        let pdfName = '';

        async function fetchPDFs() {
            const response = await fetch('https://api.github.com/repos/rpsk01/PDF-REPOSITORY-01/contents/');
            const files = await response.json();
            const pdfList = document.getElementById('pdf-list');

            files.forEach(file => {
                if (file.name.endsWith('.pdf')) {
                    const fileName = file.name.replace(/%20/g, ' ');
                    const link = document.createElement('a');
                    link.href = '#';
                    link.textContent = fileName;
                    link.onclick = () => openPDF(file.download_url, file.name);
                    pdfList.appendChild(link);
                    pdfList.appendChild(document.createElement('br'));
                }
            });
        }

        function openPDF(url, name) {
            pdfName = name;
            document.getElementById('pdf-viewer').style.display = 'block';
            pdfjsLib.getDocument(url).promise.then(pdf => {
                pdfDoc = pdf;
                renderPage(pageNum);
            });
        }

        function renderPage(num) {
            pdfDoc.getPage(num).then(page => {
                const viewport = page.getViewport({ scale: 1.5 });
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                const renderContext = {
                    canvasContext: ctx,
                    viewport: viewport
                };
                page.render(renderContext);
                document.getElementById('page-info').textContent = `Page ${num} of ${pdfDoc.numPages}`;
            });
        }

        function prevPage() {
            if (pageNum <= 1) return;
            pageNum--;
            renderPage(pageNum);
        }

        function nextPage() {
            if (pageNum >= pdfDoc.numPages) return;
            pageNum++;
            renderPage(pageNum);
        }

        function searchText() {
            const text = document.getElementById('search-input').value;
            alert('Search functionality coming soon!');
        }

        function addNote() {
            const note = document.getElementById('note-input').value;
            if (note.trim()) {
                highlights.push({ note, page: pageNum });
                document.getElementById('note-input').value = '';
                alert('Note added!');
            }
        }

        function downloadHighlights() {
            const date = new Date();
            const monthNames = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
            const formattedDate = `${date.getFullYear()}${monthNames[date.getMonth()]}${String(date.getDate()).padStart(2, '0')}`;
            const fileName = `${pdfName.replace('.pdf', '')}-HLE-${formattedDate}.txt`;

            let content = '';
            highlights.forEach(h => {
                content += `Page ${h.page}:
${h.note}\n\n`;
            });

            const blob = new Blob([content], { type: 'text/plain' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            link.click();
        }

        fetchPDFs();
    </script>
</body>
</html>
